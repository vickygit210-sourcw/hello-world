---
- hosts: localhost
  tasks:
  - name: Ensure dockerhost is in running state
    amazon.aws.ec2:
      instance_tags:
        Role: dockerhost
      state: running

- hosts: tag_Role_dockerhost
  become: true
  tasks:
  - name: Install Docker Agent
    ansible.builtin.package:
      name: docker
      state: present

  - name: Add user to docker admin
    command: "{{ item }}"
    with_items:
      - service docker start
      - systemctl enable docker
      - usermod -a -G docker ec2-user
    ignore_errors: yes

  - name: Delete running container
    command: docker stop regapp-server
    ignore_errors: yes

  - name: Remove the container
    command: docker rm regapp-server
    ignore_errors: yes

  - name: Delete old image
    command: docker rmi vicky210/regapp:latest
    ignore_errors: yes

  - name: create container
    command: docker run -d --name regapp-server -p 8088:8080 vicky210/regapp:latest
